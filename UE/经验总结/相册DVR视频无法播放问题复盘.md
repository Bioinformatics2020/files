问题描述：

在相册中无法播放DVR(行车记录仪)视频。这个是相册中一直存在但还未来得及解决的重大问题。



解决问题的流程：

1. 视频播放支持多种方法，如本地视频、网络视频、MP4格式、AVI格式等等。经过多次测试，发现只有播放DVR设备的录像视频会出问题。

2. 在ue中使用一个功能非常简单的demo测试，最终发现依然无法播放，排除相册逻辑问题。

3. 查阅ue视频播放相关源代码，发现ue仅仅是调用安卓播放器接口，不太可能出现问题。于是决定检查播放器本身。它通过ExoPlayer采用http流的方式获取资源，采用MP4格式播放视频。

4. 经过安卓同事测试，切换exoPlayer播放器为其它播放器视频播放问题也无法彻底解决，同时会引入其它问题。经与甲方沟通得知，它们也在使用exoplayer，但具体如何解决无从得知。
5. 下载exoplayer官方demo进行视频播放测试，发现视频依然无法播放，且现象同ue的demo一致。至此确认问题应该先排查播放器本身。
6. 经过对exoplayer官方demo的断点调试与不断测试，发现图像渲染哪一帧，有一个专门的计时器去管理，对计时器相关代码做修改测试后发现，只要计时器正常输出应该播放的进度，则显示就是正常的。
7. 经过exoplayer播放器理论学习与代码检查，发现进度条可以由两套系统进行管理，分别为默认时钟进度与音频时钟进度，为保证更好的观看体验，当音频存在时，优先按照音频进度播放。
8. 测试过程中发现，由于未知原因，音频进度回调异常。将其修改为按照默认进度播放则一切恢复正常。以哪个时钟进度为准只有异常情况下体验的较小差异，故当前修改在当前项目中影响可控。
9. 我虽然在exoplayer官方demo中找到问题，但是依然需要安卓同事帮助解决打包集成问题，将修改后的exoplayer集成到ue环境中，集成过程也遇到一系列问题，待安卓同事一一解决后，我们继续测试相册视频播放问题。
10. 集成后测试发现，我的demo可以正常播放，但是相册内部依然播放异常，目前可以确定相册内部依然存在问题。接下来继续对相册代码进行修改与测试。
11. 测试下来发现相册读取视频分辨率时，ue播放器返回值异常，但是相册没有考虑到播放器会出错，导致没有完善异常情况下的代码。我认为没有必要修改分辨率返回值异常的问题，这里只需要对DVR录像视频写死分辨率为16:9即可。待以后DVR设备更新，或许这些问题都不复存在。
12. 修改完毕后集成复测，无法播放问题解决。总结一下：DVR设备有bug，我们花了较大力气为它打上了补丁。



修改的代码：

1. 修改exoplayer视频播放的时钟选择，对应ExoPlayerImplInternal.java文件2600行

   ```java
   mediaClock.onRendererEnabled(renderer);
   
   //改为
   if(rendererIndex == 0)//仅使用默认时钟
   {
       mediaClock.onRendererEnabled(renderer);
   }
   ```

2. 环境配置相关代码，对应NIC与Launcher的gradle文件

3. 对相册分辨率读取函数添加补丁，对应WBP_Album_VideoPlay文件UpdatePicScaler宏。补丁内容为若分辨率读取异常则使用默认1920*1080分辨率